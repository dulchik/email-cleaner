<!doctype html>
<html>
<head>
<meta charset="utf-8" />
<title>Inbox Cleaner</title>
<style>
  body { font-family: Arial, sans-serif; padding: 20px; }
  .batch { border: 1px solid #ccc; margin-bottom: 10px; padding: 10px; }
  .emails { display: none; margin-top: 10px; }
  .toggle { cursor: pointer; color: blue; text-decoration: underline; }
  table { width: 100%; border-collapse: collapse; margin-top: 10px; }
  th, td { border: 1px solid #ddd; padding: 5px; }
  .unsub-btn { padding: 4px 8px; }
</style>
</head>
<body>

<h1>Inbox Cleaner</h1>

Sort:
<select id="sort">
  <option value="">None</option>
  <option value="fromAsc">From A-Z</option>
  <option value="fromDesc">From Z-A</option>
  <option value="countDesc">Most Emails</option>
  <option value="countAsc">Least Emails</option>
</select>

Filter:
<select id="filter">
  <option value="">All</option>
  <option value="withUnsub">Only with Unsubscribe</option>
  <option value="noUnsub">Only without Unsubscribe</option>
</select>

<div id="progress" style="margin-top:10px; font-weight:bold;"></div>

<div id="list" style="margin-top:20px;"></div>

<script>
async function refresh() {
  const sort = document.getElementById('sort').value;
  const filter = document.getElementById('filter').value;

  const res = await fetch('/api/emails?sort=' + sort + '&filter=' + filter);
  const data = await res.json();

  // progress
  document.getElementById('progress').innerText =
    `Fetching IDs: ${data.total_ids} | Fetched emails: ${data.fetched_count}`;

  const container = document.getElementById('list');
  container.innerHTML = '';

  data.batches.forEach(batch => {
    const div = document.createElement('div');
    div.className = 'batch';

    div.innerHTML = `
      <div><strong>${batch.sender}</strong> â€” ${batch.emails.length} emails
        <span class="toggle">[expand]</span>
        <button class="delete-all">Delete All</button>
      </div>
      <div class="emails">
         <table>
           <tr><th>Subject</th><th>Date</th><th>Unsubscribe</th></tr>
           ${
             batch.emails.map(e => `
               <tr>
                 <td>${e.subject || ''}</td>
                 <td>${e.date || ''}</td>
                 <td>${
                    e.unsub
                    ? `<a href="${e.unsub}" target="_blank"><button class="unsub-btn">Unsub</button></a>`
                    : ''
                 }</td>
               </tr>
             `).join('')
           }
         </table>
      </div>
    `;

    container.appendChild(div);

    // toggle dropdown
    const toggle = div.querySelector('.toggle');
    const emailsDiv = div.querySelector('.emails');

    toggle.addEventListener('click', () => {
      if (emailsDiv.style.display === 'none') {
        emailsDiv.style.display = 'block';
        toggle.textContent = '[collapse]';
      } else {
        emailsDiv.style.display = 'none';
        toggle.textContent = '[expand]';
      }
    });

    // delete all button
    div.querySelector('.delete-all').addEventListener('click', async () => {
      if (!confirm(`Delete all emails from ${batch.sender}?`)) return;
      await fetch('/api/delete-batch?sender=' + encodeURIComponent(batch.sender), { method: 'POST' });
      refresh();
    });
  });
}

// auto-refresh progress & list every 2 seconds
setInterval(refresh, 2000);
refresh();
</script>

</body>
</html>
